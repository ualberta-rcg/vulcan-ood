<%
# Application configuration and template setup
app_name = "VS Code Server"
template_root = "/var/www/ood/apps/templates/"

# Get the first available VS Code version to use as default
first_label, first_value = CustomAppVersions.code_server_module_list.first

# GPU configuration data passed to JavaScript for dynamic form behavior
gpu_data = {
  "gpu_types" => CustomGPUInfo.gpu_types,
  "gpu_name_mappings" => CustomGPUInfo.gpu_name_mappings.transform_keys(&:to_s),
  "gpu_max_counts" => CustomGPUInfo.gpu_max_counts.transform_keys(&:to_s)
}

# Application-specific minimum resource requirements
min_cores = 8
min_mem_gb = 4
%>
---
# JavaScript file for client-side form validation and dynamic behavior
javascript:
  - form.js

# Application title displayed in the interface
title: <%= app_name %>

# Form field definitions and configuration
attributes:
  # Hidden field containing GPU information for JavaScript form logic
  gpudata:
    widget: hidden_field
    cacheable: false
    value: "<%= gpu_data.to_json.gsub('"','\\"') %>"

  # Hidden field with cluster's maximum memory per node for validation
  memorydata:
    widget: hidden_field
    cacheable: false
    value: "<%= CustomClusterInfo.max_memory_per_node %>"

  # Hidden field with cluster's maximum CPUs per node for validation
  cpunum:
    widget: hidden_field
    cacheable: false
    value: "<%= CustomClusterInfo.max_cpus_per_node %>"

  # Cluster selection dropdown (typically only one option)
  cluster:
    widget: select
    label: Cluster
    options:
      - "<%= CustomClusterInfo.cluster_name %>"

  # Hidden field with application-specific minimum CPU requirement
  mincpu:
    widget: hidden_field
    cacheable: false
    value: "<%= min_cores %>"

  # Hidden field with application-specific minimum memory requirement
  minram:
    widget: hidden_field
    cacheable: false
    value: "<%= min_mem_gb %>"

  # Hidden field with automatically selected VS Code version (uses first available)
  code_server_version:
    widget: hidden_field
    value: "<%= first_value %>"

# Import common job parameters from template (cores, hours, email, VNC resolution, etc.)
<% IO.foreach(template_root+"job_params") do |line| %><%= line %><% end %>

  # Force memory customization to be enabled for this application
  memtask_checkbox:
    value: "1"
    cacheable: false
    widget: hidden_field

# Form field display order and layout
form:
  - cluster                    # Cluster selection
  - bc_num_hours              # Job runtime limit
  - code_server_version       # Hidden: VS Code version (auto-selected)
  - memorydata                # Hidden: max memory available
  - cpunum                    # Hidden: max CPUs available
  - mincpu                    # Hidden: minimum CPUs required
  - minram                    # Hidden: minimum memory required
# Import form fields from template (CPU cores, memory, GPU options, VNC settings, etc.)
<% IO.foreach(template_root+"form_params") do |line| %><%= line %><% end %>

