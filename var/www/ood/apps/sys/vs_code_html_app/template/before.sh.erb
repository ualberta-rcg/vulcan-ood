#!/bin/bash

# Export module if available
[[ $(type -t module) == "function" ]] && export -f module

# Get user and UID
USER_NAME="${USER:-$(whoami)}"
USER_UID="$(id -u "$USER_NAME" 2>/dev/null || getent passwd "$USER_NAME" | cut -d: -f3)"
echo "[before.sh.erb] User: $USER_NAME (UID: $USER_UID)"

# Setup /run/user
sudo /usr/local/bin/create-ice.sh "$USER_UID"

# Set working dir for OOD (used by launch scripts like kde.sh)
export OOD_DIR="${PWD}"
export HOME_DIR="${HOME}"
echo "[before.sh.erb] OOD_DIR: $OOD_DIR"
echo "[before.sh.erb] HOME_DIR: $HOME_DIR"

# Find available port to run server on
export port=$(find_port ${host})
echo "[before.sh.erb] Selected port: $port"

# Clean problematic env vars
unset DBUS_SESSION_BUS_ADDRESS
unset DBUS_SESSION_BUS_PID
unset XDG_SESSION_TYPE
unset WAYLAND_DISPLAY

# Set fallback XDG_RUNTIME_DIR
export XDG_RUNTIME_DIR="/tmp/xdg-runtime-$USER_UID"
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"
echo "[before.sh.erb] XDG_RUNTIME_DIR set to $XDG_RUNTIME_DIR"

# GPU detection
VGL_LIB_PATH="/usr/lib"
GPU_PRESENT=$(nvidia-smi --query-gpu=name --format=csv,noheader,nounits 2>/dev/null | grep -v "^$" | head -n 1)

if [[ -n "$GPU_PRESENT" && "$GPU_PRESENT" != "No devices were found" && -f "${VGL_LIB_PATH}/libdlfaker.so" && -f "${VGL_LIB_PATH}/libvglfaker.so" ]]; then
  export OOD_GPU_AVAILABLE=true
  export VGL_DISPLAY=egl
  export LD_PRELOAD="${VGL_LIB_PATH}/libdlfaker.so:${VGL_LIB_PATH}/libvglfaker.so"
  echo "[before.sh.erb] GPU detected: $GPU_PRESENT"
  echo "[before.sh.erb] VirtualGL enabled"
else
  export OOD_GPU_AVAILABLE=false
  export LIBGL_ALWAYS_SOFTWARE=1
  export QT_QUICK_BACKEND=software
  echo "[before.sh.erb] No GPU or VirtualGL missing â€” using software rendering"
fi

# Set environment variables
export CODESERVER_LOG_FILE="${OOD_DIR}/code-server.log"
export CODESERVER_DATA_HOME="${HOME_DIR}/.vscode-ood"
export CODESERVER_PASSWORD="$(create_passwd 16)"
export password="$CODESERVER_PASSWORD"

echo "[before.sh.erb] CODESERVER_LOG_FILE: $CODESERVER_LOG_FILE"
echo "[before.sh.erb] CODESERVER_DATA_HOME: $CODESERVER_DATA_HOME"

# Create data directory
if ! mkdir -p "$CODESERVER_DATA_HOME"; then
  echo "[before.sh.erb] ERROR: Failed to create $CODESERVER_DATA_HOME"
  exit 1
else
  echo "[before.sh.erb] Successfully created $CODESERVER_DATA_HOME"
fi

echo "[before.sh.erb] Setup complete."
