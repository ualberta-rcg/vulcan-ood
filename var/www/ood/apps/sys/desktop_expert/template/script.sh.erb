#!/usr/bin/env bash

echo "[script.sh.erb] Starting desktop environment setup for user: $USER"
echo "[script.sh.erb] Working directory: $HOME"
cd "${HOME}" || {
  echo "[script.sh.erb] ERROR: Failed to change to home directory: $HOME"
  exit 1
}

# Reset modules to a clean state
echo "[script.sh.erb] Purging and restoring modules..."
module purge && module restore

# Set the login shell
export SHELL="$(getent passwd "$USER" | cut -d: -f7)"
echo "[script.sh.erb] SHELL set to: $SHELL"

# Add xhost so that Firefox works
xhost +SI:localuser:$USER

# Websockify port information
echo "[script.sh.erb] websockify is listening on port: ${WEBSOCKIFY_PORT}"

# Display the desktop environment being launched
echo "[script.sh.erb] Launching desktop session: '<%= context.desktop %>'..."

# Construct path to desktop launcher script
DESKTOP_SCRIPT="<%= session.staged_root.join("desktops", "#{context.desktop}.sh") %>"

# Confirm script exists before sourcing
if [[ -x "$DESKTOP_SCRIPT" ]]; then
  echo "[script.sh.erb] Executing desktop startup script: $DESKTOP_SCRIPT"
  source "$DESKTOP_SCRIPT"
  echo "[script.sh.erb] Desktop session '<%= context.desktop %>' exited with status $?"
else
  echo "[script.sh.erb] ERROR: Desktop script not found or not executable: $DESKTOP_SCRIPT"
  exit 1
fi

