# Export the module function if it exists
[[ $(type -t module) == "function" ]] && export -f module

# Determine current user info for logging
USER_NAME="${USER:-$(whoami)}"
USER_UID="$(id -u "$USER_NAME" 2>/dev/null || getent passwd "$USER_NAME" | cut -d: -f3)"
echo "[before.sh.erb] Username: $USER_NAME"
echo "[before.sh.erb] UID: $USER_UID"

export XDG_RUNTIME_DIR="/run/user/$USER_UID"

if [ ! -d "$XDG_RUNTIME_DIR" ] || [ ! -w "$XDG_RUNTIME_DIR" ]; then
  echo "[before.sh.erb] WARNING: $XDG_RUNTIME_DIR not usable. Falling back."
  export XDG_RUNTIME_DIR="/tmp/xdg-runtime-$USER_UID"
  mkdir -p "$XDG_RUNTIME_DIR"
  chmod 700 "$XDG_RUNTIME_DIR"
  chown "$USER_UID:$USER_UID" "$XDG_RUNTIME_DIR"
fi

echo "[before.sh.erb] XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR created and permissioned"

# Handle D-Bus
if [[ -z "${DBUS_SESSION_BUS_ADDRESS}" ]]; then
  eval "$(dbus-launch --sh-syntax --exit-with-session)"
  echo "[before.sh.erb] D-Bus session started with address: $DBUS_SESSION_BUS_ADDRESS"
else
  echo "[before.sh.erb] D-Bus session already running."
fi

# Session-specific environment tweaks (KDE/Plasma)
if [[ "<%= context.desktop %>" == "kde" || "<%= context.desktop %>" == "plasma" ]]; then
  echo "[before.sh.erb] KDE/Plasma detected â€“ applying environment tweaks..."

  # Force software rendering for Qt (avoid OpenGL crashes)
  export QT_XCB_GL_INTEGRATION=none
  export KWIN_COMPOSE=Q

  # Disable Wayland just in case
  export KDE_SESSION_VERSION=5
  export KDE_FULL_SESSION=true
  export QT_QPA_PLATFORM=xcb
  export XDG_SESSION_TYPE=x11
  export PLASMA_USE_QT_SCALING=1
fi

# Log session environment
echo "[before.sh.erb] Final environment for session:"
env | grep -E 'KDE|QT|XDG|DBUS' | sort

echo "[before.sh.erb] Done. Remaining setup is desktop-specific."

