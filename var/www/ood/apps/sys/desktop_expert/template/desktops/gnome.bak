#!/bin/bash
echo "[gnome-session.sh] Starting improved GNOME session for $USER at $(date)"

# Clean up old monitor config to avoid popups
[[ -f "${HOME}/.config/monitors.xml" ]] && mv "${HOME}/.config/monitors.xml" "${HOME}/.config/monitors.xml.bak"

# Disable disk utility popup
mkdir -p "${HOME}/.config/autostart"
if [[ -f /etc/xdg/autostart/gdu-notification-daemon.desktop ]]; then
  cat /etc/xdg/autostart/gdu-notification-daemon.desktop <(echo "X-GNOME-Autostart-enabled=false") \
    > "${HOME}/.config/autostart/gdu-notification-daemon.desktop"
fi

# Set GNOME settings - disable screensaver and session idle
gsettings set org.gnome.desktop.session idle-delay 0
gsettings set org.gnome.desktop.screensaver lock-enabled false
gsettings set org.gnome.nautilus.preferences always-use-browser true

# Environment variables
export XDG_CURRENT_DESKTOP=GNOME
export GNOME_SHELL_SESSION_MODE=classic
export GNOME_SESSION_MODE=classic
export XDG_SESSION_TYPE=x11
export GIO_USE_VFS=local
export GTK_MODULES=""
export PIPEWIRE_DISABLE=1
export DISABLE_SYSTEMD=1

# Start D-Bus cleanly
eval "$(dbus-launch --sh-syntax --exit-with-session)"
export DBUS_SESSION_BUS_ADDRESS
export DBUS_SESSION_BUS_PID

# Try running GNOME session with fallback to minimal session if it fails
{
  # Try gnome-session with fallback options
  if command -v gnome-session-classic &>/dev/null; then
    echo "[gnome-session.sh] Starting GNOME classic session..."
    gnome-session --session=gnome-classic
  elif command -v gnome-session &>/dev/null; then
    echo "[gnome-session.sh] Starting GNOME session with fallback mode..."
    gnome-session --fallback
  else
    echo "[gnome-session.sh] gnome-session not found, falling back to minimal setup"
    exit 1
  fi
} || {
  # If gnome-session fails, fall back to manual component startup
  echo "[gnome-session.sh] GNOME session failed, starting minimal components..."

  # Start a window manager
  if command -v metacity &>/dev/null; then
    metacity --replace &
  elif command -v mutter &>/dev/null; then
    mutter --replace &
  fi

  # Start panel and file manager
  gnome-panel & 
 # nautilus --no-default-window  --no-desktop &
  gnome-settings-daemon &
  clipit &

}

# Wait to keep session alive
wait

