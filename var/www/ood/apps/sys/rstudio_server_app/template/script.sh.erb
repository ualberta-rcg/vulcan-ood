#!/bin/bash

echo "[script.sh.erb] Starting RStudio Server"

# Set squid proxy for the job (R package installs, etc.)
export http_proxy="http://squid.vulcan.local:3128"
export HTTP_PROXY="http://squid.vulcan.local:3128"
export https_proxy="http://squid.vulcan.local:3128"
export HTTPS_PROXY="http://squid.vulcan.local:3128"
echo "[script.sh.erb] Set proxy: http://squid.vulcan.local:3128"

# Change to user's home directory
cd "${HOME}"
echo "[script.sh.erb] Changed working directory to ${HOME}"

# Load required modules
echo "[script.sh.erb] Loading RStudio and R modules..."
module purge

TARGET_MODULE="<%= context.rstudio_server_version %>"

# Try initial load
if module load "$TARGET_MODULE"; then
  echo "[script.sh.erb] Successfully loaded $TARGET_MODULE"
  # Show detected versions at boot
  echo "[script.sh.erb] Detected RStudio module: $TARGET_MODULE"
  if command -v Rscript >/dev/null 2>&1; then
    R_VER=$(Rscript --version 2>&1 | head -1)
    echo "[script.sh.erb] Detected R: $R_VER"
  fi
  if command -v rserver >/dev/null 2>&1; then
    RSERVER_VER=$(rserver --version 2>/dev/null | head -1 || true)
    [[ -n "$RSERVER_VER" ]] && echo "[script.sh.erb] Detected rserver: $RSERVER_VER"
  fi
else
  echo "[script.sh.erb] Initial load failed, checking prerequisites..."

  # Extract all possible prerequisites from spider
  ALL_MODULES=$(module spider "$TARGET_MODULE" 2>&1 | \
                awk '/You will need to load all module\(s\)/, /This module provides/' | \
                grep -Eo '[A-Za-z0-9_/-]+/[0-9.]+' | sort -u)

  # Filter out the target module from the list
  PREREQS=""
  for mod in $ALL_MODULES; do
    if [[ "$mod" != "$TARGET_MODULE" ]]; then
      PREREQS="$PREREQS $mod"
    fi
  done

  if [[ -n "$PREREQS" ]]; then
    echo "[script.sh.erb] Detected prerequisites: $PREREQS"
    module load $PREREQS
    echo "[script.sh.erb] Retrying load of $TARGET_MODULE..."
    if module load "$TARGET_MODULE"; then
      echo "[script.sh.erb] Successfully loaded $TARGET_MODULE after loading prerequisites."
      echo "[script.sh.erb] Detected RStudio module: $TARGET_MODULE"
      if command -v Rscript >/dev/null 2>&1; then
        R_VER=$(Rscript --version 2>&1 | head -1)
        echo "[script.sh.erb] Detected R: $R_VER"
      fi
      if command -v rserver >/dev/null 2>&1; then
        RSERVER_VER=$(rserver --version 2>/dev/null | head -1 || true)
        [[ -n "$RSERVER_VER" ]] && echo "[script.sh.erb] Detected rserver: $RSERVER_VER"
      fi
    else
      echo "[script.sh.erb] Failed to load $TARGET_MODULE even after loading prerequisites."
      exit 1
    fi
  else
    echo "[script.sh.erb] No prerequisites found. Giving up."
    exit 1
  fi
fi

# R library path: ~/.rstudio/<version>/library (version = module name, / -> -)
# RStudio and rsession will use R_LIBS_USER to find user packages
RSTUDIO_VERSION="${TARGET_MODULE//\//-}"
R_LIB_USER="${HOME}/.rstudio/${RSTUDIO_VERSION}/library"
mkdir -p "${R_LIB_USER}"
export R_LIBS_USER="${R_LIB_USER}"
echo "[script.sh.erb] R_LIBS_USER=${R_LIB_USER} (user packages)"

# Set working dir for RStudio session (do this before package install so we can start rserver quickly)
WORKDIR="${RSTUDIO_DATA_HOME}"
# Use job dir for temp so nothing goes to /tmp
export TMPDIR="${WORKDIR}/tmp"
export TEMP="${WORKDIR}/tmp"
export TMP="${WORKDIR}/tmp"
echo "[script.sh.erb] Creating RStudio working directories under ${WORKDIR} (TMPDIR=${TMPDIR})"
mkdir -p "${WORKDIR}/var/run" \
         "${WORKDIR}/var/lib" \
         "${WORKDIR}/tmp" \
         "${WORKDIR}/etc" \
         "${WORKDIR}/rstudio-server" \
         "${WORKDIR}/database"

# Write selected module name and R library path for rsession wrapper
RSTUDIO_MODULE="<%= context.rstudio_server_version %>"
echo "${RSTUDIO_MODULE}" > "${WORKDIR}/rstudio-server/rsession_module"
echo "${R_LIB_USER}" > "${WORKDIR}/rstudio-server/rsession_r_libs_user"
echo "[script.sh.erb] Wrote rsession module: ${RSTUDIO_MODULE}, R library: ${R_LIB_USER}"

# Secure cookie key
COOKIE_KEY="${WORKDIR}/rstudio-server/secure-cookie-key"
if [ ! -f "$COOKIE_KEY" ]; then
  echo "[script.sh.erb] Generating secure cookie key..."
  head -c 32 /dev/urandom > "$COOKIE_KEY"
  chmod 600 "$COOKIE_KEY"
else
  echo "[script.sh.erb] Secure cookie key already exists."
fi

# RSession wrapper: load same module and R_LIBS_USER before each R session
echo "[script.sh.erb] Creating RSession wrapper at ${RSESSION_WRAPPER_FILE}"
MODULE_FILE="${WORKDIR}/rstudio-server/rsession_module"
R_LIBS_FILE="${WORKDIR}/rstudio-server/rsession_r_libs_user"
cat > "${RSESSION_WRAPPER_FILE}" <<EOF
#!/usr/bin/env bash
exec >> "${RSESSION_LOG_FILE}" 2>&1
echo "RSession wrapper invoked"
# Temp under job dir, not /tmp
export TMPDIR="${WORKDIR}/tmp"
export TEMP="${WORKDIR}/tmp"
export TMP="${WORKDIR}/tmp"
# R package search path (same as job's ~/.rstudio/<version>/library)
if [[ -f "${R_LIBS_FILE}" ]]; then
  R_LIB=\$(cat "${R_LIBS_FILE}")
  if [[ -n "\$R_LIB" ]]; then export R_LIBS_USER="\$R_LIB"; fi
fi
# Load module environment for this R session (same as job's rstudio-server version)
MODULE_FILE="${MODULE_FILE}"
if [[ -f "\${MODULE_FILE}" ]]; then
  mod=\$(cat "\${MODULE_FILE}")
  if [[ -n "\$mod" ]]; then
    if type module &>/dev/null 2>&1; then
      module load "\$mod" 2>/dev/null && echo "Loaded module: \$mod" || true
    else
      for f in /etc/profile.d/modules.sh /usr/share/modules/init/bash /usr/share/Modules/init/bash; do
        if [[ -r "\$f" ]]; then source "\$f" 2>/dev/null && break; fi
      done
      if type module &>/dev/null 2>&1; then
        module load "\$mod" 2>/dev/null && echo "Loaded module: \$mod" || true
      fi
    fi
  fi
fi
exec rsession "\$@"
EOF

chmod +x "${RSESSION_WRAPPER_FILE}"
echo "[script.sh.erb] RSession wrapper script created."

# Database config
DB_CONFIG="${WORKDIR}/rstudio-server/database.conf"
echo "[script.sh.erb] Writing database config to ${DB_CONFIG}"
cat > "${DB_CONFIG}" <<EOF
provider=sqlite
directory=${WORKDIR}/database
EOF
echo "[script.sh.erb] Database config written."

# Install R packages in background so rserver can start immediately (avoids OOD timeout)
if command -v Rscript >/dev/null 2>&1; then
  PKG_LOG="${WORKDIR}/rstudio_pkg_install.log"
  echo "[script.sh.erb] Starting R package installation in background (log: ${PKG_LOG})"
  (
    export R_LIBS_USER="${R_LIB_USER}"
    PACKAGES=( tidyverse data.table devtools plotly DT knitr rmarkdown lubridate readxl writexl jsonlite httr xml2 )
    for pkg in "${PACKAGES[@]}"; do
      Rscript -e "
        if (!require(\"${pkg}\", quietly = TRUE, character.only = TRUE)) {
          install.packages(\"${pkg}\", repos = \"https://cloud.r-project.org\", lib = \"${R_LIB_USER}\", dependencies = TRUE)
        }
      " >> "${PKG_LOG}" 2>&1
    done
    echo "[background] Package installation finished." >> "${PKG_LOG}"
  ) &
fi

# Launch RStudio Server (foreground so OOD sees it quickly); all logs to job dir
echo "[script.sh.erb] Launching rserver (logs: ${RSTUDIO_LOG_FILE})"
rserver \
  --server-user "${USER}" \
  --www-port "${port}" \
  --auth-none 1 \
  --server-working-dir "${WORKDIR}" \
  --server-data-dir "${WORKDIR}/var/run" \
  --secure-cookie-key-file "${COOKIE_KEY}" \
  --database-config-file "${DB_CONFIG}" \
  --rsession-path "${RSESSION_WRAPPER_FILE}" \
  --server-app-armor-enabled=0 \
  >> "${RSTUDIO_LOG_FILE}" 2>&1

echo "[script.sh.erb] RStudio Server Started."
