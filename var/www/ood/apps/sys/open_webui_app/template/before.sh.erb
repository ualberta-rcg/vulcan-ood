#!/bin/bash

set -e  # Exit on error

# Ensure script is executable
chmod +x "$0" 2>/dev/null || true

echo "[before.sh.erb] Starting Open WebUI Setup..."

# Export the module function if available
if [[ $(type -t module) == "function" ]]; then
  echo "[before.sh.erb] 'module' function is available."
  export -f module
else
  echo "[before.sh.erb] WARNING: 'module' function not available."
fi

# Find available port to run server on
export port=$(find_port ${host})
if [[ -z "$port" ]]; then
  echo "[before.sh.erb] ERROR: Failed to allocate a port."
  exit 1
else
  echo "[before.sh.erb] Selected available port: $port"
fi

# Needed for Alliance Clusters
export CC_CLUSTER=vulcan

# Open WebUI working directory (in job directory, which is in tmp)
export WEBUI_WORKDIR="${PWD}/webui-data"
export WEBUI_LOG_FILE="${PWD}/webui.log"
# Venv in /tmp as requested
export WEBUI_VENV_DIR="/tmp/${USER}_webui_env"

echo "[before.sh.erb] WEBUI_WORKDIR: $WEBUI_WORKDIR"
echo "[before.sh.erb] WEBUI_LOG_FILE: $WEBUI_LOG_FILE"
echo "[before.sh.erb] WEBUI_VENV_DIR: $WEBUI_VENV_DIR"

# Create working directory
mkdir -p "$WEBUI_WORKDIR"
echo "[before.sh.erb] Successfully created Open WebUI working directory."

# ============================================================================
# CRITICAL: Load required modules BEFORE creating venv or running pip
# ============================================================================
echo "[before.sh.erb] Loading required modules..."
module purge

echo "[before.sh.erb] Loading python/3.12.4..."
module load python/3.12.4

echo "[before.sh.erb] Loading rust/1.91.0..."
module load rust/1.91.0

echo "[before.sh.erb] Loading arrow..."
module load arrow

echo "[before.sh.erb] Loading opencv..."
module load opencv

echo ""
echo "[before.sh.erb] IMPORTANT: Modules loaded. If you have an active virtual environment,"
echo "[before.sh.erb] you must deactivate it first."
echo ""

# Check if we're in a virtual environment (shouldn't be, but check anyway)
if [[ -n "$VIRTUAL_ENV" ]]; then
  echo "[before.sh.erb] ERROR: You are currently in a virtual environment: $VIRTUAL_ENV"
  echo "[before.sh.erb] Please deactivate it first, then re-run this script."
  exit 1
fi

# Create virtual environment in /tmp if it doesn't exist
# NOTE: Modules are already loaded above, so venv will use the correct Python
if [ ! -d "$WEBUI_VENV_DIR" ]; then
  echo "[before.sh.erb] Creating virtual environment at $WEBUI_VENV_DIR..."
  python -m venv "$WEBUI_VENV_DIR"
else
  echo "[before.sh.erb] Virtual environment already exists at $WEBUI_VENV_DIR"
fi

# Activate environment
# NOTE: Modules remain loaded after venv activation
echo "[before.sh.erb] Activating virtual environment..."
source "$WEBUI_VENV_DIR/bin/activate"

# Upgrade pip (modules are still loaded from above)
echo "[before.sh.erb] Upgrading pip..."
pip install --upgrade pip

# Install pytz explicitly first (in case it's needed)
# NOTE: Modules must be loaded before this runs
echo "[before.sh.erb] Installing pytz..."
pip install pytz

# Install open-webui (only if not already installed)
if ! python -c "import open_webui" 2>/dev/null; then
  echo "[before.sh.erb] Installing open-webui..."
  pip install open-webui
  echo "[before.sh.erb] Successfully installed open-webui"
else
  echo "[before.sh.erb] open-webui already installed"
fi

# ============================================================================
# Nginx will be built in script.sh.erb in the job directory (WEBUI_WORKDIR)
# This avoids hardcoded path issues and ensures temp directories are created
# in the correct location relative to where nginx runs.
# ============================================================================

echo ""
echo "[before.sh.erb] =========================================="
echo "[before.sh.erb] Setup complete!"
echo "[before.sh.erb] =========================================="
echo ""
echo "[before.sh.erb] IMPORTANT: Modules (python, rust, arrow, opencv) are loaded"
echo "[before.sh.erb] and will remain loaded for the session."
echo "[before.sh.erb] =========================================="
